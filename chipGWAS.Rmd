---
title: "chipGWAS"
author: "Husain Agha"
date: "1/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(root.dir="/Users/husainagha/Documents/GitHub.nosync/NationalTrialEnv/")
library(tidyverse); library(GWASpoly); library(fuzzyjoin); library(readxl); library(janitor); library(statgenGxE)
source(file = "ascer.fn.R")
source(file = "newReadGWASpoly.fn.R")
```

```{r data import, include=F}
chipPhenoSelected <- read_csv("chipPhenoSelected.csv")
chipGenoSelected <- read_csv("chipGenoSelected.csv")

fryPhenoSelected <- read_csv("fryPhenoSelected.csv")
fryGenoSelected <- read_csv("fryGenoSelected.csv")

wisconsinChips <- chipPhenoSelected %>% 
                    select(variety, sel.site, trial) %>%
                    mutate(sel.site = ifelse(sel.site == "Wisconsin", 1, 0))

```

```{r chipGWAS}

data <- read.GWASpoly.object(ploidy = 4, 
                             phenos = wisconsinChips,
                             genos = chipGenoSelected,
                             n.traits = 1,
                             format = "numeric")

data.original <- set.K(data, LOCO=FALSE)

params <- set.params(geno.freq  = 1 - (10/605))

data.original.scan <- GWASpoly(data.original,
                               models=c("additive"),
                               traits=c("sel.site"),
                               params=params)

qq.plot(data.original.scan,trait="sel.site") + ggtitle(label="Original")
data2 <- set.threshold(data.original.scan,method="FDR",level=0.05)

p <- manhattan.plot(data2,traits="sel.site")
p + theme(axis.text.x = element_text(angle=90,vjust=0.5))

```

```{r fry GWAS}

data <- read.GWASpoly(ploidy = 4, 
                      pheno.file = "fryGWASpheno.csv", 
                      geno.file = "fryGWASgeno.csv", 
                      format = "numeric", 
                      n.traits = 1)

data.original <- set.K(data, 
                       LOCO=FALSE)

params <- set.params(geno.freq  = 1 - 10/135,
                     fixed      = c("program", "trial"),
                     fixed.type = c("factor", "factor"))
Sys.time()

data.original.scan <- GWASpoly(data = data.original,
                               models = c("additive", "1-dom"),
                               traits=c("total_weight"),
                               params=params,
                               n.core = 4)

Sys.time()

qq.plot(data.original.scan,trait="total_weight") + ggtitle(label="Original")
data2 <- set.threshold(data.original.scan,method="Bonferroni",level=0.05)

p <- manhattan.plot(data2,traits="total_weight")
p + theme(axis.text.x = element_text(angle=90,vjust=0.5))


```

```{r read in env data}

location <- c("Florida", "NorthCarolina", "Texas", "Michigan", "NorthDakota", "NewYork", "Wisconsin", "California", "Minnesota", "Colorado", "Oregon")
long <- c(-81.4333, -76.650, -102.7441, -85.1768, -97.6281, -76.344808, -89.523177, -118.88)
lat <- c(29.6833, 35.8333, 35.9713, 43.3505, 48.5469, 42.512151, 44.133584, 35.2580)
city <- c("Hastings", "Plymouth", "Dalhart", "Douglass", "Hoople", "Freeville", "Hancock", "Bakersfield", "Becker", "", "Hermiston")

locations <- tibble(state = location,  city = city, latitude = lat, longitude = long)

minTemp <- read_xlsx("all_env_data.xlsx", "min_temp") %>% 
  pivot_longer(Jan:Annual, names_to = "month", values_to = "minTemp") %>%
  filter(month != "Annual", Year != "Mean")

maxTemp <- read_xlsx("all_env_data.xlsx", "max_temp") %>% 
  pivot_longer(Jan:Annual, names_to = "month", values_to = "maxTemp") %>%
  filter(month != "Annual", Year != "Mean")

GDD50 <- read_xlsx("all_env_data.xlsx", "gdd_50") %>% 
  pivot_longer(Jan:Annual, names_to = "month", values_to = "gdd50") %>%
  filter(month != "Annual", Year != "Mean")

precip <- read_xlsx("all_env_data.xlsx", "precip") %>% 
  pivot_longer(Jan:Annual, names_to = "month", values_to = "precip") %>%
  filter(month != "Annual", Year != "Mean")

avgTemp <- read_xlsx("all_env_data.xlsx", "avg_temp") %>% 
  pivot_longer(Jan:Annual, names_to = "month", values_to = "avgTemp") %>%
  filter(month != "Annual", Year != "Mean")

```

```{r GxE}

# chips_gxeTD_total <- statgenSTA::createTD(chipPhenoFinal, genotype = "variety", trial = "trial")

chips_gxe_split <- chipPhenoFinal %>% 
  mutate(trial1 = trial, yield_total = as.numeric(yield_total)) %>%
  separate(trial1, into = c("year", "location"), sep = "_") %>%
  mutate_if(is.character, as.factor) %>%
  group_by(year) %>%
  group_split()

chips_gxeTD <- lapply(chips_gxe_split, function(x){statgenSTA::createTD(data = x, genotype = "variety", trial = "trial")})

lapply(X = chips_gxeTD, FUN = function(x){plot(x, plotType = "box", traits = "yield_total", colorTrialBy = "location",
     orderBy = "descending")})

thing <- lapply(chips_gxeTD, function(x){gxeVarComp(TD = x, trait = "yield_total")})
lapply(thing, function(x){summary(x)})

chipFW <- lapply(chips_gxeTD, function(x){gxeFw(TD = x, trait = "yield_total")})

lapply(chipFW, function(x){plot(x, plotType = "line", colorGenoBy = "sel.site")})
```

```{r rho/fst}

chip_pop_split <- as_tibble(cbind(variety = names(chipGeno), t(chipGeno)))[-c(2,3),] %>% 
  row_to_names(row_number = 1) %>%
  rename(variety = marker) %>%
  mutate(code = ifelse(str_sub(variety, 2L, 2L) == ".",
                                     "W",
                                     only_letters(variety))) %>%
  regex_right_join(programCodes, by = "code") %>%
  relocate(sel.site, code.y, code.x, .before = variety) %>%
  filter(!is.na(variety), !duplicated(variety)) %>%
  select(-code.y, -code.x, -cross.site) %>%
  group_by(sel.site) %>%
  group_split(.keep = T)

chip_pop_split_named <- lapply(chip_pop_split, function(x){
  x %>% column_to_rownames("variety")
})

genos <- NULL
for(i in 1:9){
  for(j in (i+1):10){
    store <- list(rbind(chip_pop_split_named[[i]][,-1], chip_pop_split_named[[j]][,-1]))
    genos <- append(genos, store)
  }
}
pops <- NULL
for(i in 1:9){
  for(j in (i+1):10){
    store <- list(rownames(chip_pop_split_named[[i]]), rownames(chip_pop_split_named[[j]]))
    pops <- append(pops, list(store))
  }
}

names <- NULL
for(i in 1:9){
  for(j in (i+1):10){
    store <- matrix(c(unique(chip_pop_split_named[[i]][,1]), unique(chip_pop_split_named[[j]][,1])), ncol = 2)
    names <- rbind(names, store)
  }
}
names <- tibble(site1 = names[,1], site2 = names[,2])
names <- names %>% mutate(names = str_c(site1, "", site2)) %>% select(names)

diversityStats <- NULL
for(i in 1:45){
    store <- list(get.rho(matrix(as.numeric(as.matrix(genos[[i]])), ncol = ncol(genos[[i]]), 
                            dimnames = dimnames(genos[[i]])), pops[[i]]))
    diversityStats <- append(diversityStats, store)
  }


names(diversityStats) <- pull(names)

chipMap <- chipGeno %>% select(marker, chrom, position)

rho.plot <- NULL
for(i in 1:45){

  rho.plot.i = tibble(marker = names(diversityStats[[i]][["rho"]]),
                      rho = diversityStats[[i]][["rho"]])           %>% 
    left_join(chipMap, by = "marker", keep = F)                     %>% 
    ggplot(aes(x = position, y = rho, color = chrom))               + 
    geom_point(alpha = 0.3, na.rm = T)                              + 
    ylim(c(0, 1))
  
  rho.plot <- append(rho.plot, list(rho.plot.i))
}

for(i in 1:45){
  print(rho.plot[[i]])
}

```

```{r mega-environment}

chips_gxe_split_1per <- chipPhenoFinal %>% 
  mutate(trial1 = trial, yield_total = as.numeric(yield_total)) %>%
  separate(trial1, into = c("year", "location"), sep = "_") %>%
  mutate_if(is.character, as.factor) %>%
  group_by(location, year) %>%
  filter(!duplicated(variety)) %>%
  mutate(location = as.character(location)) %>%
  select(-trial) %>%
  ungroup() %>%
  group_by(year) %>%
  group_split()

chips_gxeTD_1per <- lapply(chips_gxe_split_1per, function(x){statgenSTA::createTD(data = x, genotype = "variety", trial = "location")})

lapply(chips_gxeTD_1per, function(x){gxeMegaEnv(x, trait = "yield_total")}) %>% lapply(., summary)

chips_gxe_year_location <- chipPhenoFinal %>% 
  separate(trial, into = c("year", "location"), sep = "_")



```
